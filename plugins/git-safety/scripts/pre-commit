#!/bin/bash
# Git Safety Pre-Commit Hook
# Scans staged files for secrets using Gitleaks and TruffleHog

set -e

# Get staged files that exist (not deleted)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
    echo "[Git Safety] No staged files to scan"
    exit 0
fi

# Create temp directory for staged content
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# Copy staged files to temp directory
while IFS= read -r file; do
    [ -z "$file" ] && continue
    mkdir -p "$TEMP_DIR/$(dirname "$file")"
    git show ":$file" > "$TEMP_DIR/$file" 2>/dev/null || true
done <<< "$STAGED_FILES"

ERRORS_FOUND=0

# ============================================================
# Gitleaks Scanning
# ============================================================

if command -v gitleaks &> /dev/null; then
    echo "[Gitleaks] Scanning staged files for secrets..."

    if ! gitleaks detect --source "$TEMP_DIR" --no-git --no-banner --redact 2>&1; then
        echo ""
        echo "=========================================="
        echo "COMMIT BLOCKED - Gitleaks Found Secrets"
        echo "=========================================="
        echo ""
        echo "To investigate: gitleaks detect --source . --no-git --verbose"
        echo "To bypass (CAUTION): git commit --no-verify"
        echo ""
        ERRORS_FOUND=1
    else
        echo "[Gitleaks] No secrets detected"
    fi
else
    echo "[Gitleaks] Not installed - skipping"
    echo "  Install: brew install gitleaks"
    echo "  Or: https://github.com/gitleaks/gitleaks/releases"
fi

# ============================================================
# TruffleHog Scanning
# ============================================================

if command -v trufflehog &> /dev/null; then
    echo "[TruffleHog] Scanning staged files for secrets..."

    TRUFFLEHOG_OUTPUT=$(trufflehog filesystem "$TEMP_DIR" --no-update --no-verification 2>&1 || true)

    if echo "$TRUFFLEHOG_OUTPUT" | grep -q "Found unverified result\|Found verified result"; then
        echo ""
        echo "=========================================="
        echo "COMMIT BLOCKED - TruffleHog Found Secrets"
        echo "=========================================="
        echo "$TRUFFLEHOG_OUTPUT"
        echo ""
        echo "To investigate: trufflehog filesystem . --no-update"
        echo "To bypass (CAUTION): git commit --no-verify"
        echo ""
        ERRORS_FOUND=1
    else
        echo "[TruffleHog] No secrets detected"
    fi
else
    echo "[TruffleHog] Not installed - skipping"
    echo "  Install: brew install trufflehog"
    echo "  Or: https://github.com/trufflesecurity/trufflehog/releases"
fi

# ============================================================
# Result
# ============================================================

if [ $ERRORS_FOUND -ne 0 ]; then
    echo ""
    echo "Commit blocked due to potential secrets in staged files."
    echo "Review the findings above before proceeding."
    exit 1
fi

echo "[Git Safety] All checks passed"
exit 0
